<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaboom.js Level Editor</title>
    <style>
        #levelDisplay {
            position: relative;
            width: 2048px; /* Adjust based on your level width and tile size */
            height: 1345px; /* Adjust based on your level height and tile size */
            border: 2px solid #000;
            background-color: #99CCFF;
        }
        .tile {
            position: absolute;
            width: 32px;  /* Adjust to match your tile size */
            height: 32px;  /* Adjust to match your tile size */
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-size: cover;  /* Ensures the image covers the whole tile */
            font-family: monospace;
            font-size: 0;  /* Hide text */
            object-fit: contain;
        }

        #tools {
            padding: 10px;
            background-color: #e9e9e9;
            margin-top: 10px;
        }
        button {
            margin-right: 10px;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <div id="levelDesigner">
        <div id="levelDisplay"></div>
        <div id="tools">
            <button data-tile="=">Ground (=)</button>
            <button data-tile="?">Fake Ground (?)</button>
            <button data-tile="$">Coin ($)</button>
            <button data-tile="^">Spike (^)</button>
            <button data-tile="v">Downward Spike (v)</button>
            <button data-tile="O">Portal (O)</button>
            <button data-tile="l">Jumpy (l)</button>
            <button data-tile="D">Door (D)</button>
            <button data-tile="k">Key (k)</button>
            <button data-tile=">">Right Block (>)</button>
            <button data-tile="<">Left Block (<)</button>
            <button data-tile=".">Block (.)</button>
            <button data-tile="{">Left Signpost ({)</button>
            <button data-tile="}">Right Signpost (})</button>
            <button data-tile="-">Signpost (-)</button>
            <button data-tile="i">Invisible Danger (i)</button>
            <button data-tile="S">Spawn (S)</button>
            <button data-tile="Q">Invisible Danger (Q)</button>
            <button data-tile="G">Ghost (G)</button>
            <button data-tile="!">Down Arrow (!)</button>
            <!-- Add more buttons for additional tile types -->
        </div>
        <button id="saveLevel">Save Level</button>
        <button id="loadLevel">Load Level</button>
        <button id="importLevel">Import Level</button>
        <button id="exportLevel">Export Level</button>
        <button id="launchGame">Test Level in Game</button>
    </div>

    <script>
        const tools = document.getElementById('tools');
        const levelDisplay = document.getElementById('levelDisplay');
        let selectedTile = ' '; // Default to empty space

        tools.addEventListener('click', function(event) {
            if (event.target.tagName === 'BUTTON') {
                selectedTile = event.target.getAttribute('data-tile');
            }
        });

        onKeyDown('187', () => { selectedTile = '=' })
        onKeyDown('191', () => { selectedTile = '?' })
        onKeyDown('52', () => { selectedTile = '$' })
        onKeyDown('54', () => { selectedTile = '^' })
        onKeyDown('86', () => { selectedTile = 'v' })
        onKeyDown('79', () => { selectedTile = 'O' })
        onKeyDown('76', () => { selectedTile = 'l' })
        onKeyDown('68', () => { selectedTile = 'D' })
        onKeyDown('75', () => { selectedTile = 'k' })
        onKeyDown('188', () => { selectedTile = '<' })
        onKeyDown('190', () => { selectedTile = '>' })
        onKeyDown('219', () => { selectedTile = '{' })
        onKeyDown('221', () => { selectedTile = '}' })
        onKeyDown('189', () => { selectedTile = '-' })
        onKeyDown('73', () => { selectedTile = 'i' })
        onKeyDown('83', () => { selectedTile = 'S' })
        onKeyDown('81', () => { selectedTile = 'Q' })
        onKeyDown('71', () => { selectedTile = 'G' })
        onKeyDown('49', () => { selectedTile = '!' })

        const loadedLevel = JSON.parse(localStorage.getItem('savedLevel'));
            if (loadedLevel) {
                LEVELS[currentLevel] = loadedLevel;
                drawLevel(LEVELS[currentLevel]);
            }

        const LEVELS = [
            Array.from({length: 42}, () => Array(64).fill(' ')) // Create 20 rows of 64 columns filled with empty space
        ];
        
        function getImageUrl(tile) {
            switch(tile) {
                case '=': return 'assets/sprites/grass.png';
                case '^': return 'assets/sprites/spike.png';
                case '$': return 'assets/sprites/coin.png';
                case 'O': return 'assets/sprites/portal.png';
                case 'l': return 'assets/sprites/jumpy.png';
                case 'D': return 'assets/sprites/door.png';
                case 'k': return 'assets/sprites/key.png';
                case '>': return 'assets/sprites/coasterRight.png';
                case '<': return 'assets/sprites/coasterLeft.png';
                case '.': return 'assets/sprites/block.png';
                case '{': return 'assets/sprites/signpostl.png';
                case '}': return 'assets/sprites/signpostr.png';
                case '-': return 'assets/sprites/signposte.png';
                case 'i': return 'assets/sprites/invisspike.png';
                case 'S': return 'assets/sprites/invisspike.png';
                case 'Q': return 'assets/sprites/invisspike.png';
                case 'G': return 'assets/sprites/ghosty.png';
                case '!': return 'assets/sprites/darrow.png';
                case 'v': return 'assets/sprites/dspike.png';
                case '?': return 'assets/sprites/fake.png'; // Add paths for each tile type
                default: return ''; // Default image for unknown types
            }
        }

        function drawLevel(level) {
            levelDisplay.innerHTML = '';
            level.forEach((row, y) => {
                row.forEach((tile, x) => {
                    const tileElement = document.createElement('div');
                    tileElement.className = 'tile';
                    tileElement.style.left = `${x * 32}px`;
                    tileElement.style.top = `${y * 32}px`;
                    tileElement.style.backgroundImage = `url('${getImageUrl(tile)}')`;
                    tileElement.addEventListener('click', () => {
                        LEVELS[0][y][x] = selectedTile === tile ? ' ' : selectedTile;
                        drawLevel(LEVELS[0]);
                    });
                    levelDisplay.appendChild(tileElement);
                });
            });
        }

        function importLevel(levelArray) {
            const newLevel = levelArray.map(row => row.split(''));
            LEVELS[0] = newLevel;
            drawLevel(LEVELS[0]);
        
            // Calculate the height based on the number of rows
            document.getElementById('levelDisplay').style.height = `${newLevel.length * 32}px`;
        
            // Find the maximum length of any row
            const maxWidth = newLevel.reduce((max, row) => Math.max(max, row.length), 0);
        
            // Set the width based on the maximum length
            document.getElementById('levelDisplay').style.width = `${maxWidth * 32}px`;
            document.getElementById('levelDisplay').style.border = '2px solid #000';
        }

        


        let currentLevel = 0;
        drawLevel(LEVELS[currentLevel]);

        document.getElementById('saveLevel').addEventListener('click', () => {
            localStorage.setItem('savedLevel', JSON.stringify(LEVELS[currentLevel]));
        });

        document.getElementById('loadLevel').addEventListener('click', () => {
            const loadedLevel = JSON.parse(localStorage.getItem('savedLevel'));
            if (loadedLevel) {
                LEVELS[currentLevel] = loadedLevel;
                drawLevel(LEVELS[currentLevel]);
            }
        });

        document.getElementById('importLevel').addEventListener('click', () => {
            const levelString = prompt("Paste the level string here (remove the last comma in the array first, if there is one after the last string):");
            // Replace single quotes with double quotes before parsing
            const levelArray = JSON.parse(levelString.replace(/'/g, '"'));
            importLevel(levelArray);
        });


        document.getElementById('exportLevel').addEventListener('click', () => {
            const exportText = LEVELS[currentLevel].map(row => "'" + row.join('') + "'").join(",\n");
            navigator.clipboard.writeText(exportText).then(() => {
                alert('Level code copied to clipboard! Use it in your game by pasting and processing it.');
            });
        });

        //create a button to launch the game with the test level
        //to do this, we need to save the level to local storage
        //then go to the root of the page with the params ?test=true
        document.getElementById('launchGame').addEventListener('click', () => {
            const exportText = LEVELS[currentLevel].map(row => "'" + row.join('') + "'").join(",\n");
            localStorage.setItem('savedLevel', JSON.stringify(LEVELS[currentLevel]));
            localStorage.setItem('levelToTest', exportText);
            window.location.href = 'index.html?test=true';
        });

    </script>
</body>
</html>
